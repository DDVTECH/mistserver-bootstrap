#!/usr/bin/env bash
set -euo pipefail

# mist-videogen - Generate test video stream for MistServer
# Generates a test pattern with timestamp and audio tone

# ─────────────────────────────────────────────────────────────────────────────
# Usage
# ─────────────────────────────────────────────────────────────────────────────

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  cat <<EOF
Usage: mist-videogen [ffmpeg-output-options...]

Generate a test video stream using FFmpeg.
Creates a test pattern with timestamp overlay and audio tone.

Examples:
  mist-videogen -f flv rtmp://localhost:1935/live/test
  mist-videogen -f mpegts udp://localhost:1234
  mist-videogen output.mp4

Notes:
  - Requires FFmpeg to be installed
  - Press Ctrl+C to stop the stream
EOF
  exit 0
fi

# Check ffmpeg is available
if ! command -v ffmpeg >/dev/null 2>&1; then
  echo "Error: FFmpeg is not installed. Install with: apt install ffmpeg" >&2
  exit 1
fi

# Generate test pattern with audio
# - testsrc: test pattern (800x600)
# - drawtext: timestamp overlay
# - aevalsrc: synthesized audio tone with variation
exec ffmpeg -re -f lavfi -i "aevalsrc=if(eq(floor(t)\,ld(2))\,st(0\,random(4)*3000+1000))\;st(2\,floor(t)+1)\;st(1\,mod(t\,1))\;(0.6*sin(1*ld(0)*ld(1))+0.4*sin(2*ld(0)*ld(1)))*exp(-4*ld(1)) [out1]; testsrc=s=800x600,drawtext=borderw=5:fontcolor=white:fontsize=30:text='%{localtime}/%{pts\:hms}':x=\(w-text_w\)/2:y=\(h-text_h-line_h\)/2 [out0]" \
  -acodec aac -vcodec h264 -strict -2 -pix_fmt yuv420p -profile:v baseline -level 3.0 \
  "$@"
